---
import { languages } from '../i18n/ui';
import { getLangFromUrl, getLocalizedPath, getPathWithoutLang } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const pathWithoutLang = getPathWithoutLang(Astro.url);
const normalizedPath = pathWithoutLang === '/' ? '' : pathWithoutLang.replace(/^\/|\/$/g, '');
const localizedPaths = Object.fromEntries(
  Object.keys(languages).map((lang) => [
    lang,
    getLocalizedPath(normalizedPath, lang as keyof typeof languages),
  ])
);
---

<div class="language-selector relative inline-block">
  <select 
    id="language-select" 
    class="theme-input rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-transparent border transition-all duration-300"
  >
    {Object.entries(languages).map(([lang, name]) => (
      <option value={lang} selected={lang === currentLang} data-href={localizedPaths[lang]}>
        {name}
      </option>
    ))}
  </select>
</div>

<script is:inline>
  document.getElementById('language-select')?.addEventListener('change', (e) => {
    const select = e.target as HTMLSelectElement;
    const target = select.selectedOptions[0];
    const newPath = target?.dataset.href;
    const suffix = window.location.search + window.location.hash;

    if (newPath) {
      window.location.href = `${newPath}${suffix}`;
    }
  });
</script>

<style>
  .language-selector select {
    cursor: pointer;
  }
</style>
